{% extends "public_layout.html" %}

{% block content %}
<section class="py-3 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-sm-10 col-md-8 col-lg-6 col-xl-5 col-xxl-4">
                <div class="card border border-light-subtle rounded-3 shadow-sm">
                    <div class="card-body p-3 p-md-4 p-xl-5">
                        <div class="text-center mb-3">
                            <a href="#!">
                                <img src="{{ url_for('static', filename='img/favicon.ico') }}" alt="For Life S.A Logo" width="50" height="50">
                            </a>
                        </div>
                        <h2 class="fs-6 fw-normal text-center text-secondary mb-4">Reset your password</h2>
                        <form class="needs-validation" novalidate id="resetPasswordForm">
                            <div class="row gy-2 overflow-hidden">
                                <div class="col-12">
                                    <div class="form-floating mb-3">
                                        <input type="password" class="form-control" name="password" id="password" placeholder="Password" required>
                                        <label for="password" class="form-label">New Password</label>
                                        <div class="invalid-feedback">
                                            Please enter your new password.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating mb-3">
                                        <input type="password" class="form-control" name="retypedPassword" id="retypedPassword" placeholder="Retype Password" required>
                                        <label for="retypedPassword" class="form-label">Retype New Password</label>
                                        <div class="invalid-feedback">
                                            Please retype your new password.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-grid my-3">
                                        <button class="btn btn-primary btn-lg" type="submit">Change your password</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <div id="error-message" class="alert alert-danger d-none" role="alert"></div>
                        <div id="success-message" class="alert alert-success d-none" role="alert"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('resetPasswordForm');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');

    form.addEventListener('submit', async (event) => {
        event.preventDefault();

        if (!form.checkValidity()) {
            event.stopPropagation();
            form.classList.add('was-validated');
            return;
        }

        const password = document.getElementById('password').value;
        const retypedPassword = document.getElementById('retypedPassword').value;

        if (password !== retypedPassword) {
            errorMessage.textContent = 'Passwords do not match.';
            errorMessage.classList.remove('d-none');
            return;
        }

        const formData = new FormData(form);
        const data = {
            password: formData.get('password')
        };

        try {
            const response = await fetch("{{ url_for('api.auth.reset_password', token=token) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data),
            });

            const res = await response.json();

            if (!response.ok) {
                throw new Error(res.error || 'An error occurred');
            }

            const modalElement = document.getElementById('statusSuccessModal');
                const successModalTxt = document.getElementById('successModalText');
                const successModal = new bootstrap.Modal(modalElement);
                successModalTxt.textContent = res.message;

                modalElement.addEventListener('hidden.bs.modal', function() {
                    window.location.href = "{{ url_for('app.auth.login') }}";
                });
                successModal.show();
        } catch (error) {
            errorMessage.textContent = error.message;
            errorMessage.classList.remove('d-none');
            successMessage.classList.add('d-none');
        }
    });
});
</script>
{% endblock %}